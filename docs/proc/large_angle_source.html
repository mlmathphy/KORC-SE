<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
   
   <meta name="description" content="Kinetic Orbit Runaway electrons Code (KORC)">
    
    <meta name="author" content="Matt Beidler" >
    <link rel="icon" href="../favicon.png">

    <title>large_angle_source &ndash; KORC</title>

    <link href="../css/bootstrap.min.css" rel="stylesheet">
    <link href="../css/pygments.css" rel="stylesheet">
    <link href="../css/font-awesome.min.css" rel="stylesheet">
    <link href="../css/local.css" rel="stylesheet">
    
    <link  href="../tipuesearch/tipuesearch.css" rel="stylesheet">
    
    

    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
    
    <script src="../js/jquery-2.1.3.min.js"></script>
    <script src="../js/svg-pan-zoom.min.js"></script>

  </head>

  <body>

    <!-- Fixed navbar -->
    <nav class="navbar navbar-inverse navbar-fixed-top">
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="../index.html">KORC </a>
        </div>
        <div id="navbar" class="navbar-collapse collapse">
          <ul class="nav navbar-nav">
        
            <li><a href='../page/index.html'>README</a></li>
      
            <li class="dropdown hidden-xs visible-sm visible-md hidden-lg">
              <a href="#" class="dropdown-toggle"
              data-toggle="dropdown" role="button"
              aria-haspopup="true"
     aria-expanded="false">Contents <span class="caret"></span></a>
        <ul class="dropdown-menu">
          
              
            <li><a href="../lists/files.html">Source Files</a></li>
        
        
        
            <li><a href="../lists/modules.html">Modules</a></li>
        
            
                                
            <li><a href="../lists/procedures.html">Procedures</a></li>
        
               
            <li><a href="../lists/types.html">Derived Types</a></li>
        
        
            <li><a href="../program/main.html">Program</a></li>
      
            </ul>
            </li>


<li class="visible-xs hidden-sm visible-lg"><a href="../lists/files.html">Source Files</a></li>



<li class="visible-xs hidden-sm visible-lg"><a href="../lists/modules.html">Modules</a></li>



<li class="visible-xs hidden-sm visible-lg"><a href="../lists/procedures.html">Procedures</a></li>

                             
<li class="visible-xs hidden-sm visible-lg"><a href="../lists/types.html">Derived Types</a></li>


<li class="visible-xs hidden-sm visible-lg"><a href="../program/main.html">Program</a></li>

          </ul>
        
        <form action="../search.html" class="navbar-form navbar-right" role="search">
        <div class="form-group">
          <input type="text" class="form-control" placeholder="Search" name="q" id="tipue_search_input" autocomplete="off" required>
        </div>
<!--
        <button type="submit" class="btn btn-default">Submit</button>
-->
        </form>
        
        </div><!--/.nav-collapse -->
      </div>
    </nav>

    <div class="container">
    
  
  <div class="row">
    <h1>large_angle_source
      <small>Subroutine</small>
    
    </h1>
    
<div class="row">
  <div class="col-lg-12">
<div class="well well-sm">
  <ul class="list-inline" style="margin-bottom:0px;display:inline">
     
     
     
     
    
    
     <li><i class="fa fa-list-ol"></i>
       <a data-toggle="tooltip"
    data-placement="bottom" data-html="true"
    title=" 0.7% of total for procedures.">185 statements</a>
     </li> 
     
     
     
    <li><i class="fa fa-code"></i><a href="../src/korc_collisions.f90"> Source File</a></li>
     
     
  </ul>
  <ol class="breadcrumb in-well text-right">
  
    
     <li><a href='../sourcefile/korc_collisions.f90.html'>korc_collisions.f90</a></li>
    
     <li><a href='../module/korc_collisions.html'>korc_collisions</a></li>
    
  
     <li class="active">large_angle_source</li>
  </ol>
</div>
</div>
</div>
<script>
  $(function () {
  $('[data-toggle="tooltip"]').tooltip()
  })
</script>

  </div>
  
  <div class="row">
    <div class="col-md-3 hidden-xs hidden-sm visible-md visible-lg">
    
<div id="sidebar">
  
<h3>Contents</h3>
 





















<div class="panel panel-primary">
  <div class="panel-heading text-left"><h3 class="panel-title">Source Code</h3></div>
  <div class="list-group">
    <a class="list-group-item" href="../proc/large_angle_source.html#src">large_angle_source</a>
  </div>
</div>



</div>

    </div>
    
    <div class="col-md-9" id='text'>
    <h2>
public subroutine large_angle_source(spp, params, achunk, F, Y_R, Y_PHI, Y_Z, pm, xi, ne, netot, Te, Bmag, E_PHI, me, flagCol, flagCon)
    
    
   
</h2>
    
  


    
    <p>For each primary RE, calculating probability to generate a secondary RE</p>
<p>Generating 1D and 2D ranges for secondary RE distribution</p>
<p>Saving maximum secondary RE source for use in rejection-acceptance
 sampling algorithm 
 Trapezoidal integration of secondary RE source to find probabilty</p>
<p>If secondary RE generated, begin acceptance-rejection sampling
 algorithm</p>
<p>Write secondary RE degrees of freedom to particle derived type</p>
<p>Write changes to primary RE degrees of freedom to temporary
 arrays for passing back out to particle derived type</p>
    

    <h3>Arguments</h3>
    
      
<table class="table table-striped varlist">
<thead><tr><th>Type</th>
<th>Intent</th><th>Optional</th>
<th>Attributes</th><th></th><th>Name</th><th></th></thead>



<tbody>

  
  
  
  
<tr>
  
  <td><span class="anchor" id="variable-spp~9"></span>type(SPECIES),</td>
  <td>intent(inout)</td>
  <td></td>
  
  <td></td><td>::</td>
  <td><strong>spp</strong></td><td></td>
  
</tr>

  
  
  
  
<tr>
  
  <td><span class="anchor" id="variable-params~39"></span>type(KORC_PARAMS),</td>
  <td>intent(in)</td>
  <td></td>
  
  <td></td><td>::</td>
  <td><strong>params</strong></td><td></td>
  
</tr>

  
  
  
  
<tr>
  
  <td><span class="anchor" id="variable-achunk~2"></span>integer,</td>
  <td>intent(in)</td>
  <td></td>
  
  <td></td><td>::</td>
  <td><strong>achunk</strong></td><td></td>
  
</tr>

  
  
  
  
<tr>
  
  <td><span class="anchor" id="variable-f~12"></span>type(FIELDS),</td>
  <td>intent(in)</td>
  <td></td>
  
  <td></td><td>::</td>
  <td><strong>F</strong></td><td></td>
  
</tr>

  
  
  
  
<tr>
  
  <td><span class="anchor" id="variable-y_r~4"></span>real(kind=rp),</td>
  <td>intent(in),</td>
  <td></td>
  
  <td>DIMENSION(achunk)</td><td>::</td>
  <td><strong>Y_R</strong></td><td></td>
  
</tr>

  
  
  
  
<tr>
  
  <td><span class="anchor" id="variable-y_phi~4"></span>real(kind=rp),</td>
  <td>intent(in),</td>
  <td></td>
  
  <td>DIMENSION(achunk)</td><td>::</td>
  <td><strong>Y_PHI</strong></td><td></td>
  
</tr>

  
  
  
  
<tr>
  
  <td><span class="anchor" id="variable-y_z~4"></span>real(kind=rp),</td>
  <td>intent(in),</td>
  <td></td>
  
  <td>DIMENSION(achunk)</td><td>::</td>
  <td><strong>Y_Z</strong></td><td></td>
  
</tr>

  
  
  
  
<tr>
  
  <td><span class="anchor" id="variable-pm"></span>real(kind=rp),</td>
  <td>intent(inout),</td>
  <td></td>
  
  <td>DIMENSION(achunk)</td><td>::</td>
  <td><strong>pm</strong></td><td></td>
  
</tr>

  
  
  
  
<tr>
  
  <td><span class="anchor" id="variable-xi"></span>real(kind=rp),</td>
  <td>intent(inout),</td>
  <td></td>
  
  <td>DIMENSION(achunk)</td><td>::</td>
  <td><strong>xi</strong></td><td></td>
  
</tr>

  
  
  
  
<tr>
  
  <td><span class="anchor" id="variable-ne~29"></span>real(kind=rp),</td>
  <td>intent(in),</td>
  <td></td>
  
  <td>DIMENSION(achunk)</td><td>::</td>
  <td><strong>ne</strong></td><td></td>
  
</tr>

  
  
  
  
<tr>
  
  <td><span class="anchor" id="variable-netot"></span>real(kind=rp),</td>
  <td>intent(in),</td>
  <td></td>
  
  <td>DIMENSION(achunk)</td><td>::</td>
  <td><strong>netot</strong></td><td></td>
  
</tr>

  
  
  
  
<tr>
  
  <td><span class="anchor" id="variable-te~31"></span>real(kind=rp),</td>
  <td>intent(in),</td>
  <td></td>
  
  <td>DIMENSION(achunk)</td><td>::</td>
  <td><strong>Te</strong></td><td></td>
  
</tr>

  
  
  
  
<tr>
  
  <td><span class="anchor" id="variable-bmag"></span>real(kind=rp),</td>
  <td>intent(in),</td>
  <td></td>
  
  <td>DIMENSION(achunk)</td><td>::</td>
  <td><strong>Bmag</strong></td><td></td>
  
</tr>

  
  
  
  
<tr>
  
  <td><span class="anchor" id="variable-e_phi~4"></span>real(kind=rp),</td>
  <td>intent(in),</td>
  <td></td>
  
  <td>DIMENSION(achunk)</td><td>::</td>
  <td><strong>E_PHI</strong></td><td></td>
  
</tr>

  
  
  
  
<tr>
  
  <td><span class="anchor" id="variable-me~7"></span>real(kind=rp),</td>
  <td>intent(in)</td>
  <td></td>
  
  <td></td><td>::</td>
  <td><strong>me</strong></td><td></td>
  
</tr>

  
  
  
  
<tr>
  
  <td><span class="anchor" id="variable-flagcol~7"></span>integer(kind=is),</td>
  <td>intent(in),</td>
  <td></td>
  
  <td>DIMENSION(achunk)</td><td>::</td>
  <td><strong>flagCol</strong></td><td></td>
  
</tr>

  
  
  
  
<tr>
  
  <td><span class="anchor" id="variable-flagcon~7"></span>integer(kind=is),</td>
  <td>intent(in),</td>
  <td></td>
  
  <td>DIMENSION(achunk)</td><td>::</td>
  <td><strong>flagCon</strong></td><td></td>
  
</tr>

</tbody>
</table>

    
    
    
    <br>
    
    
    <div class="panel panel-default">
      <div class="panel-heading">
  <h3 class="panel-title">Calls</h3>
      </div>
      <div class="panel-body">
  <div class="depgraph"><?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN"
 "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<!-- Generated by graphviz version 2.40.1 (20161225.0304)
 -->
<!-- Title: proc~~large_angle_source~~CallsGraph Pages: 1 -->
<svg id="proclarge_angle_sourceCallsGraph" width="459pt" height="158pt"
 viewBox="0.00 0.00 459.00 158.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="proc~~large_angle_source~~CallsGraph" class="graph" transform="scale(1 1) rotate(0) translate(4 154)">
<title>proc~~large_angle_source~~CallsGraph</title>
<polygon fill="#ffffff" stroke="transparent" points="-4,4 -4,-154 455,-154 455,4 -4,4"/>
<!-- proc~large_angle_source -->
<g id="proc~~large_angle_source~~CallsGraph_node1" class="node">
<title>proc~large_angle_source</title>
<polygon fill="none" stroke="#000000" points="105,-87 0,-87 0,-63 105,-63 105,-87"/>
<text text-anchor="middle" x="52.5" y="-72.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#000000">large_angle_source</text>
</g>
<!-- proc~gammacee -->
<g id="proc~~large_angle_source~~CallsGraph_node2" class="node">
<title>proc~gammacee</title>
<g id="a_proc~~large_angle_source~~CallsGraph_node2"><a xlink:href=".././proc/gammacee.html" xlink:title="Gammacee">
<polygon fill="#d94e8f" stroke="#d94e8f" points="209,-129 142,-129 142,-105 209,-105 209,-129"/>
<text text-anchor="middle" x="175.5" y="-114.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#ffffff">Gammacee</text>
</a>
</g>
</g>
<!-- proc~large_angle_source&#45;&gt;proc~gammacee -->
<g id="proc~~large_angle_source~~CallsGraph_edge1" class="edge">
<title>proc~large_angle_source&#45;&gt;proc~gammacee</title>
<path fill="none" stroke="#000000" d="M87.7469,-87.0355C101.5897,-91.7623 117.6171,-97.2351 132.1571,-102.2"/>
<polygon fill="#000000" stroke="#000000" points="131.346,-105.6214 141.9405,-105.5407 133.608,-98.9969 131.346,-105.6214"/>
</g>
<!-- korc_abort -->
<g id="proc~~large_angle_source~~CallsGraph_node3" class="node">
<title>korc_abort</title>
<polygon fill="#777777" stroke="#777777" points="206.5,-87 144.5,-87 144.5,-63 206.5,-63 206.5,-87"/>
<text text-anchor="middle" x="175.5" y="-72.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#ffffff">korc_abort</text>
</g>
<!-- proc~large_angle_source&#45;&gt;korc_abort -->
<g id="proc~~large_angle_source~~CallsGraph_edge2" class="edge">
<title>proc~large_angle_source&#45;&gt;korc_abort</title>
<path fill="none" stroke="#000000" d="M105.0198,-75C114.7927,-75 124.8747,-75 134.25,-75"/>
<polygon fill="#000000" stroke="#000000" points="134.4806,-78.5001 144.4805,-75 134.4805,-71.5001 134.4806,-78.5001"/>
</g>
<!-- proc~get_random -->
<g id="proc~~large_angle_source~~CallsGraph_node4" class="node">
<title>proc~get_random</title>
<g id="a_proc~~large_angle_source~~CallsGraph_node4"><a xlink:href=".././proc/get_random.html" xlink:title="get_random">
<polygon fill="#d94e8f" stroke="#d94e8f" points="210,-45 141,-45 141,-21 210,-21 210,-45"/>
<text text-anchor="middle" x="175.5" y="-30.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#ffffff">get_random</text>
</a>
</g>
</g>
<!-- proc~large_angle_source&#45;&gt;proc~get_random -->
<g id="proc~~large_angle_source~~CallsGraph_edge3" class="edge">
<title>proc~large_angle_source&#45;&gt;proc~get_random</title>
<path fill="none" stroke="#000000" d="M87.7469,-62.9645C101.2436,-58.3558 116.8171,-53.0381 131.0639,-48.1733"/>
<polygon fill="#000000" stroke="#000000" points="132.3408,-51.4358 140.6732,-44.8921 130.0787,-44.8113 132.3408,-51.4358"/>
</g>
<!-- proc~clogee -->
<g id="proc~~large_angle_source~~CallsGraph_node5" class="node">
<title>proc~clogee</title>
<g id="a_proc~~large_angle_source~~CallsGraph_node5"><a xlink:href=".././proc/clogee.html" xlink:title="CLogee">
<polygon fill="#d94e8f" stroke="#d94e8f" points="330.5,-129 276.5,-129 276.5,-105 330.5,-105 330.5,-129"/>
<text text-anchor="middle" x="303.5" y="-114.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#ffffff">CLogee</text>
</a>
</g>
</g>
<!-- proc~gammacee&#45;&gt;proc~clogee -->
<g id="proc~~large_angle_source~~CallsGraph_edge4" class="edge">
<title>proc~gammacee&#45;&gt;proc~clogee</title>
<path fill="none" stroke="#000000" d="M209.1305,-117C226.5915,-117 247.9787,-117 265.9753,-117"/>
<polygon fill="#000000" stroke="#000000" points="266.1243,-120.5001 276.1242,-117 266.1242,-113.5001 266.1243,-120.5001"/>
</g>
<!-- omp_get_thread_num -->
<g id="proc~~large_angle_source~~CallsGraph_node6" class="node">
<title>omp_get_thread_num</title>
<polygon fill="#777777" stroke="#777777" points="361,-66 246,-66 246,-42 361,-42 361,-66"/>
<text text-anchor="middle" x="303.5" y="-51.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#ffffff">omp_get_thread_num</text>
</g>
<!-- proc~get_random&#45;&gt;omp_get_thread_num -->
<g id="proc~~large_angle_source~~CallsGraph_edge5" class="edge">
<title>proc~get_random&#45;&gt;omp_get_thread_num</title>
<path fill="none" stroke="#000000" d="M210.1386,-38.6829C218.1001,-39.9891 226.8355,-41.4222 235.6686,-42.8714"/>
<polygon fill="#000000" stroke="#000000" points="235.2121,-46.3432 245.6468,-44.5085 236.3454,-39.4356 235.2121,-46.3432"/>
</g>
<!-- interface~random_get_number -->
<g id="proc~~large_angle_source~~CallsGraph_node7" class="node">
<title>interface~random_get_number</title>
<g id="a_proc~~large_angle_source~~CallsGraph_node7"><a xlink:href=".././interface/random_get_number.html" xlink:title="random_get_number">
<polygon fill="#a7506f" stroke="#a7506f" points="358.5,-24 248.5,-24 248.5,0 358.5,0 358.5,-24"/>
<text text-anchor="middle" x="303.5" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#ffffff">random_get_number</text>
</a>
</g>
</g>
<!-- proc~get_random&#45;&gt;interface~random_get_number -->
<g id="proc~~large_angle_source~~CallsGraph_edge6" class="edge">
<title>proc~get_random&#45;&gt;interface~random_get_number</title>
<path fill="none" stroke="#000000" d="M210.1386,-27.3171C218.8208,-25.8927 228.4234,-24.3173 238.0693,-22.7347"/>
<polygon fill="#000000" stroke="#000000" points="238.7989,-26.1619 248.1003,-21.089 237.6656,-19.2542 238.7989,-26.1619"/>
</g>
<!-- proc~clog0 -->
<g id="proc~~large_angle_source~~CallsGraph_node8" class="node">
<title>proc~clog0</title>
<g id="a_proc~~large_angle_source~~CallsGraph_node8"><a xlink:href=".././proc/clog0.html" xlink:title="CLog0">
<polygon fill="#d94e8f" stroke="#d94e8f" points="451,-150 397,-150 397,-126 451,-126 451,-150"/>
<text text-anchor="middle" x="424" y="-135.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#ffffff">CLog0</text>
</a>
</g>
</g>
<!-- proc~clogee&#45;&gt;proc~clog0 -->
<g id="proc~~large_angle_source~~CallsGraph_edge7" class="edge">
<title>proc~clogee&#45;&gt;proc~clog0</title>
<path fill="none" stroke="#000000" d="M330.5426,-121.7128C347.093,-124.5971 368.5052,-128.3287 386.6578,-131.4922"/>
<polygon fill="#000000" stroke="#000000" points="386.1783,-134.9613 396.6308,-133.2303 387.3802,-128.0653 386.1783,-134.9613"/>
</g>
<!-- proc~vte -->
<g id="proc~~large_angle_source~~CallsGraph_node9" class="node">
<title>proc~vte</title>
<g id="a_proc~~large_angle_source~~CallsGraph_node9"><a xlink:href=".././proc/vte.html" xlink:title="VTe">
<polygon fill="#d94e8f" stroke="#d94e8f" points="451,-108 397,-108 397,-84 451,-84 451,-108"/>
<text text-anchor="middle" x="424" y="-93.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#ffffff">VTe</text>
</a>
</g>
</g>
<!-- proc~clogee&#45;&gt;proc~vte -->
<g id="proc~~large_angle_source~~CallsGraph_edge8" class="edge">
<title>proc~clogee&#45;&gt;proc~vte</title>
<path fill="none" stroke="#000000" d="M330.5426,-112.2872C347.093,-109.4029 368.5052,-105.6713 386.6578,-102.5078"/>
<polygon fill="#000000" stroke="#000000" points="387.3802,-105.9347 396.6308,-100.7697 386.1783,-99.0387 387.3802,-105.9347"/>
</g>
</g>
</svg>
</div><div><a type="button" class="graph-help" data-toggle="modal" href="#graph-help-text">Help</a></div><div class="modal fade" id="graph-help-text" tabindex="-1" role="dialog"><div class="modal-dialog modal-lg" role="document"><div class="modal-content"><div class="modal-header"><button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button><h4 class="modal-title" id="-graph-help-label">Graph Key</h4></div><div class="modal-body">
    <p>Nodes of different colours represent the following: </p>
    <?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN"
 "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<!-- Generated by graphviz version 2.40.1 (20161225.0304)
 -->
<!-- Title: Graph Key Pages: 1 -->
<svg width="554pt" height="32pt"
 viewBox="0.00 0.00 553.50 32.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 28)">
<title>Graph Key</title>
<polygon fill="#ffffff" stroke="transparent" points="-4,4 -4,-28 549.5,-28 549.5,4 -4,4"/>
<!-- Subroutine -->
<g id="node1" class="node">
<title>Subroutine</title>
<polygon fill="#d9534f" stroke="#d9534f" points="63,-24 0,-24 0,0 63,0 63,-24"/>
<text text-anchor="middle" x="31.5" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#ffffff">Subroutine</text>
</g>
<!-- Function -->
<g id="node2" class="node">
<title>Function</title>
<polygon fill="#d94e8f" stroke="#d94e8f" points="135.5,-24 81.5,-24 81.5,0 135.5,0 135.5,-24"/>
<text text-anchor="middle" x="108.5" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#ffffff">Function</text>
</g>
<!-- Interface -->
<g id="node3" class="node">
<title>Interface</title>
<polygon fill="#a7506f" stroke="#a7506f" points="207.5,-24 153.5,-24 153.5,0 207.5,0 207.5,-24"/>
<text text-anchor="middle" x="180.5" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#ffffff">Interface</text>
</g>
<!-- Unknown Procedure Type -->
<g id="node4" class="node">
<title>Unknown Procedure Type</title>
<polygon fill="#777777" stroke="#777777" points="359.5,-24 225.5,-24 225.5,0 359.5,0 359.5,-24"/>
<text text-anchor="middle" x="292.5" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#ffffff">Unknown Procedure Type</text>
</g>
<!-- Program -->
<g id="node5" class="node">
<title>Program</title>
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="431.5,-24 377.5,-24 377.5,0 431.5,0 431.5,-24"/>
<text text-anchor="middle" x="404.5" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#ffffff">Program</text>
</g>
<!-- This Page&#39;s Entity -->
<g id="node6" class="node">
<title>This Page&#39;s Entity</title>
<polygon fill="none" stroke="#000000" points="545.5,-24 449.5,-24 449.5,0 545.5,0 545.5,-24"/>
<text text-anchor="middle" x="497.5" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#000000">This Page&#39;s Entity</text>
</g>
</g>
</svg>

    
    <p>Solid arrows point from a procedure to one which it calls. Dashed 
    arrows point from an interface to procedures which implement that interface.
    This could include the module procedures in a generic interface or the
    implementation in a submodule of an interface in a parent module.
    </p>
    </div></div></div></div>
      </div>
    </div>
     
     
    <div class="panel panel-default">
      <div class="panel-heading">
  <h3 class="panel-title">Called by</h3>
      </div>
      <div class="panel-body">
  <div class="depgraph"><?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN"
 "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<!-- Generated by graphviz version 2.40.1 (20161225.0304)
 -->
<!-- Title: proc~~large_angle_source~~CalledByGraph Pages: 1 -->
<svg id="proclarge_angle_sourceCalledByGraph" width="334pt" height="32pt"
 viewBox="0.00 0.00 334.00 32.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="proc~~large_angle_source~~CalledByGraph" class="graph" transform="scale(1 1) rotate(0) translate(4 28)">
<title>proc~~large_angle_source~~CalledByGraph</title>
<polygon fill="#ffffff" stroke="transparent" points="-4,4 -4,-28 330,-28 330,4 -4,4"/>
<!-- proc~large_angle_source -->
<g id="proc~~large_angle_source~~CalledByGraph_node1" class="node">
<title>proc~large_angle_source</title>
<polygon fill="none" stroke="#000000" points="326,-24 221,-24 221,0 326,0 326,-24"/>
<text text-anchor="middle" x="273.5" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#000000">large_angle_source</text>
</g>
<!-- proc~include_coulombcollisionsla_gc_p -->
<g id="proc~~large_angle_source~~CalledByGraph_node2" class="node">
<title>proc~include_coulombcollisionsla_gc_p</title>
<g id="a_proc~~large_angle_source~~CalledByGraph_node2"><a xlink:href=".././proc/include_coulombcollisionsla_gc_p.html" xlink:title="include_CoulombCollisionsLA_GC_p">
<polygon fill="#d9534f" stroke="#d9534f" points="185,-24 0,-24 0,0 185,0 185,-24"/>
<text text-anchor="middle" x="92.5" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#ffffff">include_CoulombCollisionsLA_GC_p</text>
</a>
</g>
</g>
<!-- proc~include_coulombcollisionsla_gc_p&#45;&gt;proc~large_angle_source -->
<g id="proc~~large_angle_source~~CalledByGraph_edge1" class="edge">
<title>proc~include_coulombcollisionsla_gc_p&#45;&gt;proc~large_angle_source</title>
<path fill="none" stroke="#000000" d="M185.1209,-12C193.6827,-12 202.2191,-12 210.4235,-12"/>
<polygon fill="#000000" stroke="#000000" points="210.6151,-15.5001 220.6151,-12 210.615,-8.5001 210.6151,-15.5001"/>
</g>
</g>
</svg>
</div><div><a type="button" class="graph-help" data-toggle="modal" href="#graph-help-text">Help</a></div><div class="modal fade" id="graph-help-text" tabindex="-1" role="dialog"><div class="modal-dialog modal-lg" role="document"><div class="modal-content"><div class="modal-header"><button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button><h4 class="modal-title" id="-graph-help-label">Graph Key</h4></div><div class="modal-body">
    <p>Nodes of different colours represent the following: </p>
    <?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN"
 "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<!-- Generated by graphviz version 2.40.1 (20161225.0304)
 -->
<!-- Title: Graph Key Pages: 1 -->
<svg width="554pt" height="32pt"
 viewBox="0.00 0.00 553.50 32.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 28)">
<title>Graph Key</title>
<polygon fill="#ffffff" stroke="transparent" points="-4,4 -4,-28 549.5,-28 549.5,4 -4,4"/>
<!-- Subroutine -->
<g id="node1" class="node">
<title>Subroutine</title>
<polygon fill="#d9534f" stroke="#d9534f" points="63,-24 0,-24 0,0 63,0 63,-24"/>
<text text-anchor="middle" x="31.5" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#ffffff">Subroutine</text>
</g>
<!-- Function -->
<g id="node2" class="node">
<title>Function</title>
<polygon fill="#d94e8f" stroke="#d94e8f" points="135.5,-24 81.5,-24 81.5,0 135.5,0 135.5,-24"/>
<text text-anchor="middle" x="108.5" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#ffffff">Function</text>
</g>
<!-- Interface -->
<g id="node3" class="node">
<title>Interface</title>
<polygon fill="#a7506f" stroke="#a7506f" points="207.5,-24 153.5,-24 153.5,0 207.5,0 207.5,-24"/>
<text text-anchor="middle" x="180.5" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#ffffff">Interface</text>
</g>
<!-- Unknown Procedure Type -->
<g id="node4" class="node">
<title>Unknown Procedure Type</title>
<polygon fill="#777777" stroke="#777777" points="359.5,-24 225.5,-24 225.5,0 359.5,0 359.5,-24"/>
<text text-anchor="middle" x="292.5" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#ffffff">Unknown Procedure Type</text>
</g>
<!-- Program -->
<g id="node5" class="node">
<title>Program</title>
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="431.5,-24 377.5,-24 377.5,0 431.5,0 431.5,-24"/>
<text text-anchor="middle" x="404.5" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#ffffff">Program</text>
</g>
<!-- This Page&#39;s Entity -->
<g id="node6" class="node">
<title>This Page&#39;s Entity</title>
<polygon fill="none" stroke="#000000" points="545.5,-24 449.5,-24 449.5,0 545.5,0 545.5,-24"/>
<text text-anchor="middle" x="497.5" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#000000">This Page&#39;s Entity</text>
</g>
</g>
</svg>

    
    <p>Solid arrows point from a procedure to one which it calls. Dashed 
    arrows point from an interface to procedures which implement that interface.
    This could include the module procedures in a generic interface or the
    implementation in a submodule of an interface in a parent module.
    </p>
    </div></div></div></div>
      </div>
    </div>
     
    <br>

    <section class="visible-xs visible-sm hidden-md">
      
<h3>Contents</h3>
 





















<div class="panel panel-primary">
  <div class="panel-heading text-left"><h3 class="panel-title">Source Code</h3></div>
  <div class="list-group">
    <a class="list-group-item" href="../proc/large_angle_source.html#src">large_angle_source</a>
  </div>
</div>



    </section>
    <br class="visible-xs visible-sm hidden-md">

    

    
    
    
    
    

    
    
    
    
    


    
    
    
    <section>
    <h2><span class="anchor" id="src"></span>Source Code</h2>
    <div class="highlight"><pre><span></span>  <span class="k">subroutine </span><span class="n">large_angle_source</span><span class="p">(</span><span class="n">spp</span><span class="p">,</span><span class="n">params</span><span class="p">,</span><span class="n">achunk</span><span class="p">,</span><span class="n">F</span><span class="p">,</span><span class="n">Y_R</span><span class="p">,</span><span class="n">Y_PHI</span><span class="p">,</span><span class="n">Y_Z</span><span class="p">,</span> <span class="p">&amp;</span>
       <span class="n">pm</span><span class="p">,</span><span class="n">xi</span><span class="p">,</span><span class="n">ne</span><span class="p">,</span><span class="n">netot</span><span class="p">,</span><span class="n">Te</span><span class="p">,</span><span class="n">Bmag</span><span class="p">,</span><span class="n">E_PHI</span><span class="p">,</span><span class="n">me</span><span class="p">,</span><span class="n">flagCol</span><span class="p">,</span><span class="n">flagCon</span><span class="p">)</span>
    <span class="k">TYPE</span><span class="p">(</span><span class="n">SPECIES</span><span class="p">),</span> <span class="k">INTENT</span><span class="p">(</span><span class="n">INOUT</span><span class="p">)</span>    <span class="kd">::</span> <span class="n">spp</span>
    <span class="k">TYPE</span><span class="p">(</span><span class="n">KORC_PARAMS</span><span class="p">),</span> <span class="k">INTENT</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span> 			<span class="kd">::</span> <span class="n">params</span>
    <span class="k">TYPE</span><span class="p">(</span><span class="n">FIELDS</span><span class="p">),</span> <span class="k">INTENT</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span>                                   <span class="kd">::</span> <span class="n">F</span>
    <span class="kt">INTEGER</span><span class="p">,</span> <span class="k">INTENT</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span> <span class="kd">::</span> <span class="n">achunk</span>
    <span class="kt">REAL</span><span class="p">(</span><span class="n">rp</span><span class="p">),</span> <span class="k">INTENT</span><span class="p">(</span><span class="n">INOUT</span><span class="p">),</span> <span class="k">DIMENSION</span><span class="p">(</span><span class="n">achunk</span><span class="p">)</span>  <span class="kd">::</span> <span class="n">pm</span><span class="p">,</span><span class="n">xi</span>
    <span class="kt">REAL</span><span class="p">(</span><span class="n">rp</span><span class="p">),</span> <span class="k">INTENT</span><span class="p">(</span><span class="n">IN</span><span class="p">),</span> <span class="k">DIMENSION</span><span class="p">(</span><span class="n">achunk</span><span class="p">)</span>  <span class="kd">::</span> <span class="n">Y_R</span><span class="p">,</span><span class="n">Y_PHI</span><span class="p">,</span><span class="n">Y_Z</span>
    <span class="kt">REAL</span><span class="p">(</span><span class="n">rp</span><span class="p">),</span> <span class="k">INTENT</span><span class="p">(</span><span class="n">IN</span><span class="p">),</span> <span class="k">DIMENSION</span><span class="p">(</span><span class="n">achunk</span><span class="p">)</span>  <span class="kd">::</span> <span class="n">ne</span><span class="p">,</span><span class="n">netot</span><span class="p">,</span><span class="n">Te</span>
    <span class="kt">REAL</span><span class="p">(</span><span class="n">rp</span><span class="p">),</span> <span class="k">INTENT</span><span class="p">(</span><span class="n">IN</span><span class="p">),</span> <span class="k">DIMENSION</span><span class="p">(</span><span class="n">achunk</span><span class="p">)</span>  <span class="kd">::</span> <span class="n">Bmag</span><span class="p">,</span><span class="n">E_PHI</span>
    <span class="kt">INTEGER</span><span class="p">(</span><span class="k">is</span><span class="p">),</span> <span class="k">INTENT</span><span class="p">(</span><span class="n">IN</span><span class="p">),</span> <span class="k">DIMENSION</span><span class="p">(</span><span class="n">achunk</span><span class="p">)</span>  <span class="kd">::</span> <span class="n">flagCol</span><span class="p">,</span><span class="n">flagCon</span>
    <span class="kt">REAL</span><span class="p">(</span><span class="n">rp</span><span class="p">),</span> <span class="k">INTENT</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span>  <span class="kd">::</span> <span class="n">me</span>
    <span class="kt">REAL</span><span class="p">(</span><span class="n">rp</span><span class="p">),</span> <span class="k">DIMENSION</span><span class="p">(</span><span class="n">achunk</span><span class="p">)</span>  <span class="kd">::</span> <span class="n">gam</span><span class="p">,</span><span class="n">prob0</span><span class="p">,</span><span class="n">prob1</span>
    <span class="kt">REAL</span><span class="p">(</span><span class="n">rp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">gam_min</span><span class="p">,</span><span class="n">p_min</span><span class="p">,</span><span class="n">gammax</span><span class="p">,</span><span class="n">dt</span><span class="p">,</span><span class="n">gamsecmax</span><span class="p">,</span><span class="n">psecmax</span><span class="p">,</span><span class="n">ptrial</span>
    <span class="kt">REAL</span><span class="p">(</span><span class="n">rp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">gamtrial</span><span class="p">,</span><span class="n">cosgam1</span><span class="p">,</span><span class="n">xirad</span><span class="p">,</span><span class="n">xip</span><span class="p">,</span><span class="n">xim</span><span class="p">,</span><span class="n">xitrial</span><span class="p">,</span><span class="n">sinsq1</span><span class="p">,</span><span class="n">cossq1</span><span class="p">,</span><span class="n">pitchprob1</span>
    <span class="kt">REAL</span><span class="p">(</span><span class="n">rp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">dsigdgam1</span><span class="p">,</span><span class="n">S_LAmax</span><span class="p">,</span><span class="n">S_LA1</span><span class="p">,</span><span class="n">tmppm</span><span class="p">,</span><span class="n">gamvth</span><span class="p">,</span><span class="n">vmin</span><span class="p">,</span><span class="n">E_C</span><span class="p">,</span><span class="n">p_c</span><span class="p">,</span><span class="n">gam_c</span><span class="p">,</span><span class="n">pRE</span>
    <span class="kt">INTEGER</span> <span class="kd">::</span> <span class="n">ngam1</span><span class="p">,</span><span class="n">neta1</span>
    <span class="kt">INTEGER</span> <span class="kd">::</span> <span class="n">ii</span><span class="p">,</span><span class="n">jj</span><span class="p">,</span><span class="n">cc</span><span class="p">,</span><span class="n">seciter</span>
    <span class="kt">REAL</span><span class="p">(</span><span class="n">rp</span><span class="p">),</span> <span class="k">DIMENSION</span><span class="p">(</span><span class="n">cparams_ss</span><span class="p">%</span><span class="n">ngrid1</span><span class="p">)</span> <span class="kd">::</span> <span class="n">gam1</span><span class="p">,</span><span class="n">pm1</span><span class="p">,</span><span class="n">tmpgam1</span><span class="p">,</span><span class="n">tmpcosgam</span><span class="p">,</span><span class="n">tmpdsigdgam</span><span class="p">,</span><span class="n">tmpsecthreshgam</span><span class="p">,</span><span class="n">probtmp</span><span class="p">,</span><span class="n">intpitchprob</span>
    <span class="kt">REAL</span><span class="p">(</span><span class="n">rp</span><span class="p">),</span> <span class="k">DIMENSION</span><span class="p">(</span><span class="n">cparams_ss</span><span class="p">%</span><span class="n">ngrid1</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="kd">::</span> <span class="n">dpm1</span>
    <span class="kt">REAL</span><span class="p">(</span><span class="n">rp</span><span class="p">),</span> <span class="k">DIMENSION</span><span class="p">(</span><span class="n">cparams_ss</span><span class="p">%</span><span class="n">ngrid1</span><span class="p">)</span> <span class="kd">::</span> <span class="n">eta1</span><span class="p">,</span><span class="n">tmpsinsq</span><span class="p">,</span><span class="n">tmpcossq</span>
    <span class="kt">REAL</span><span class="p">(</span><span class="n">rp</span><span class="p">),</span> <span class="k">DIMENSION</span><span class="p">(</span><span class="n">cparams_ss</span><span class="p">%</span><span class="n">ngrid1</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="kd">::</span> <span class="n">deta1</span>
    <span class="kt">REAL</span><span class="p">(</span><span class="n">rp</span><span class="p">),</span> <span class="k">DIMENSION</span><span class="p">(</span><span class="n">cparams_ss</span><span class="p">%</span><span class="n">ngrid1</span><span class="p">,</span><span class="n">cparams_ss</span><span class="p">%</span><span class="n">ngrid1</span><span class="p">)</span> <span class="kd">::</span> <span class="n">cosgam</span><span class="p">,</span><span class="n">sinsq</span><span class="p">,</span><span class="n">cossq</span><span class="p">,</span><span class="n">tmpcossq1</span><span class="p">,</span><span class="n">pitchprob</span><span class="p">,</span><span class="n">dsigdgam</span>
    <span class="kt">REAL</span><span class="p">(</span><span class="n">rp</span><span class="p">),</span> <span class="k">DIMENSION</span><span class="p">(</span><span class="n">cparams_ss</span><span class="p">%</span><span class="n">ngrid1</span><span class="p">,</span><span class="n">cparams_ss</span><span class="p">%</span><span class="n">ngrid1</span><span class="p">)</span> <span class="kd">::</span> <span class="n">secthreshgam</span><span class="p">,</span><span class="n">pm11</span><span class="p">,</span><span class="n">gam11</span><span class="p">,</span><span class="n">eta11</span><span class="p">,</span><span class="n">S_LA</span><span class="p">,</span><span class="n">pitchrad</span>
    <span class="kt">LOGICAL</span> <span class="kd">::</span> <span class="n">accepted</span>


    <span class="n">dt</span><span class="o">=</span><span class="n">cparams_ss</span><span class="p">%</span><span class="n">coll_per_dump_dt</span><span class="o">*</span><span class="n">params</span><span class="p">%</span><span class="n">cpp</span><span class="p">%</span><span class="nb">time</span>
<span class="nb">    </span><span class="n">ngam1</span><span class="o">=</span><span class="n">cparams_ss</span><span class="p">%</span><span class="n">ngrid1</span>
    <span class="n">neta1</span><span class="o">=</span><span class="n">cparams_ss</span><span class="p">%</span><span class="n">ngrid1</span>

    
    <span class="c">!$OMP SIMD</span>
    <span class="k">do </span><span class="n">cc</span><span class="o">=</span><span class="mi">1_idef</span><span class="p">,</span><span class="n">achunk</span>
       <span class="n">gam</span><span class="p">(</span><span class="n">cc</span><span class="p">)</span> <span class="o">=</span> <span class="nb">sqrt</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">pm</span><span class="p">(</span><span class="n">cc</span><span class="p">)</span><span class="o">*</span><span class="n">pm</span><span class="p">(</span><span class="n">cc</span><span class="p">))</span>       

<span class="cp">#ifdef PARALLEL_RANDOM</span>
       <span class="n">prob0</span><span class="p">(</span><span class="n">cc</span><span class="p">)</span> <span class="o">=</span> <span class="n">get_random</span><span class="p">()</span>
<span class="cp">#else</span>
       <span class="k">call </span><span class="nb">RANDOM_NUMBER</span><span class="p">(</span><span class="n">prob0</span><span class="p">)</span>
<span class="cp">#endif</span>
       
    <span class="k">end do</span>
    <span class="c">!$OMP END SIMD</span>

    <span class="n">vmin</span><span class="o">=</span><span class="mi">1</span><span class="o">/</span><span class="nb">sqrt</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="mi">1</span><span class="o">/</span><span class="p">(</span><span class="n">cparams_ss</span><span class="p">%</span><span class="n">p_min</span><span class="o">*</span><span class="n">cparams_ss</span><span class="p">%</span><span class="n">pmin_scale</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    
    <span class="c">!! For each primary RE, calculating probability to generate a secondary RE</span>
    
    <span class="k">do </span><span class="n">cc</span><span class="o">=</span><span class="mi">1_idef</span><span class="p">,</span><span class="n">achunk</span>

       <span class="n">E_C</span><span class="o">=</span><span class="n">Gammacee</span><span class="p">(</span><span class="n">vmin</span><span class="p">,</span><span class="n">netot</span><span class="p">(</span><span class="n">cc</span><span class="p">),</span><span class="n">Te</span><span class="p">(</span><span class="n">cc</span><span class="p">))</span>

       <span class="c">!write(6,*) &#39;E&#39;,E_PHI*params%cpp%Eo</span>
       <span class="c">!write(6,*) &#39;E_C&#39;,E_C*params%cpp%Eo</span>
       <span class="c">!write(6,*) &#39;E_c,min&#39;,cparams_ms%Ec_min*params%cpp%Eo</span>
       <span class="c">!write(6,*) &#39;ne&#39;,ne(cc)*params%cpp%density</span>
       <span class="c">!write(6,*) &#39;netot&#39;,netot(cc)*params%cpp%density</span>
       <span class="c">!write(6,*) &#39;Te&#39;,Te(cc)*params%cpp%temperature</span>
       <span class="c">!write(6,*) &#39;Clog&#39;,CLogee_wu(params,ne(cc)*params%cpp%density,Te(cc)*params%cpp%temperature)</span>

       <span class="k">if</span> <span class="p">(</span><span class="n">E_C</span><span class="p">.</span><span class="n">gt</span><span class="p">.</span><span class="nb">abs</span><span class="p">(</span><span class="n">E_PHI</span><span class="p">(</span><span class="n">cc</span><span class="p">)))</span> <span class="k">cycle</span>
<span class="k">       </span>
<span class="k">       </span><span class="n">p_c</span><span class="o">=</span><span class="n">cparams_ss</span><span class="p">%</span><span class="n">pmin_scale</span><span class="o">/</span><span class="nb">sqrt</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">E_PHI</span><span class="p">(</span><span class="n">cc</span><span class="p">))</span><span class="o">/</span><span class="n">E_C</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
       <span class="n">gam_c</span><span class="o">=</span><span class="nb">sqrt</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">p_c</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>

       <span class="k">if</span><span class="p">(</span><span class="n">cparams_ss</span><span class="p">%</span><span class="n">min_secRE</span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="s1">&#39;THERM&#39;</span><span class="p">)</span> <span class="k">then</span>
<span class="k">          </span><span class="n">gam_min</span><span class="o">=</span><span class="p">(</span><span class="n">gam_c</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span>
          <span class="n">p_min</span><span class="o">=</span><span class="nb">sqrt</span><span class="p">(</span><span class="n">gam_min</span><span class="o">**</span><span class="mi">2</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
       <span class="k">else</span>
<span class="k">          </span><span class="n">gam_min</span><span class="o">=</span><span class="n">gam_c</span>
          <span class="n">p_min</span><span class="o">=</span><span class="n">p_c</span>
       <span class="k">end if</span>

<span class="k">       </span><span class="n">gammax</span><span class="o">=</span><span class="p">(</span><span class="n">gam</span><span class="p">(</span><span class="n">cc</span><span class="p">)</span><span class="o">+</span><span class="mf">1._rp</span><span class="p">)</span><span class="o">/</span><span class="mf">2._rp</span>

       <span class="k">if</span> <span class="p">(</span><span class="n">gam_min</span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="mf">1._rp</span><span class="p">)</span> <span class="k">then</span>
<span class="k">          write</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="s1">&#39;R&#39;</span><span class="p">,</span><span class="n">Y_R</span><span class="p">(</span><span class="n">cc</span><span class="p">)</span><span class="o">*</span><span class="n">params</span><span class="p">%</span><span class="n">cpp</span><span class="p">%</span><span class="n">length</span><span class="p">,</span><span class="s1">&#39;Z&#39;</span><span class="p">,</span><span class="n">Y_Z</span><span class="p">(</span><span class="n">cc</span><span class="p">)</span><span class="o">*</span><span class="n">params</span><span class="p">%</span><span class="n">cpp</span><span class="p">%</span><span class="n">length</span>
          <span class="k">write</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="s1">&#39;vmin&#39;</span><span class="p">,</span><span class="n">vmin</span><span class="p">,</span><span class="s1">&#39;netot&#39;</span><span class="p">,</span><span class="n">netot</span><span class="p">(</span><span class="n">cc</span><span class="p">)</span><span class="o">*</span><span class="n">params</span><span class="p">%</span><span class="n">cpp</span><span class="p">%</span><span class="n">density</span><span class="p">,</span><span class="s1">&#39;Te&#39;</span><span class="p">,</span><span class="n">Te</span><span class="p">(</span><span class="n">cc</span><span class="p">)</span><span class="o">*</span><span class="n">params</span><span class="p">%</span><span class="n">cpp</span><span class="p">%</span><span class="n">temperature</span><span class="o">/</span><span class="n">C_E</span>
          <span class="k">write</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="s1">&#39;E&#39;</span><span class="p">,</span><span class="n">E_PHI</span><span class="o">*</span><span class="n">params</span><span class="p">%</span><span class="n">cpp</span><span class="p">%</span><span class="n">Eo</span><span class="p">,</span><span class="s1">&#39;E_c&#39;</span><span class="p">,</span><span class="n">E_C</span><span class="o">*</span><span class="n">params</span><span class="p">%</span><span class="n">cpp</span><span class="p">%</span><span class="n">Eo</span>          
          <span class="k">write</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="s1">&#39;p_c&#39;</span><span class="p">,</span><span class="n">p_c</span><span class="p">,</span><span class="s1">&#39;gam_c&#39;</span><span class="p">,</span><span class="n">gam_c</span>
          <span class="k">write</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="s1">&#39;p_min&#39;</span><span class="p">,</span><span class="n">p_min</span><span class="p">,</span><span class="s1">&#39;gam_min&#39;</span><span class="p">,</span><span class="n">gam_min</span>
          <span class="c">!write(6,*) &#39;LAC_gam_resolution: &#39;,TRIM(cparams_ss%LAC_gam_resolution)</span>
          <span class="c">!write(6,*) &#39;gam_min,gammax&#39;,gam_min,gammax</span>
       <span class="k">end if</span>
       
       <span class="c">!! Generating 1D and 2D ranges for secondary RE distribution</span>

       <span class="k">if</span> <span class="p">(</span><span class="nb">TRIM</span><span class="p">(</span><span class="n">cparams_ss</span><span class="p">%</span><span class="n">LAC_gam_resolution</span><span class="p">).</span><span class="n">eq</span><span class="p">.</span><span class="s1">&#39;LIN&#39;</span><span class="p">)</span> <span class="k">then</span>
<span class="k">          do </span><span class="n">ii</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">ngam1</span>
             <span class="n">gam1</span><span class="p">(</span><span class="n">ii</span><span class="p">)</span><span class="o">=</span><span class="n">gam_min</span><span class="o">+</span><span class="p">(</span><span class="n">gammax</span><span class="o">-</span><span class="n">gam_min</span><span class="p">)</span><span class="o">*</span> <span class="p">&amp;</span>
                  <span class="kt">REAL</span><span class="p">(</span><span class="n">ii</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="kt">REAL</span><span class="p">(</span><span class="n">ngam1</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
          <span class="k">end do</span>
<span class="k">       </span><span class="n">elseif</span> <span class="p">(</span><span class="nb">TRIM</span><span class="p">(</span><span class="n">cparams_ss</span><span class="p">%</span><span class="n">LAC_gam_resolution</span><span class="p">).</span><span class="n">eq</span><span class="p">.</span><span class="s1">&#39;EXP&#39;</span><span class="p">)</span> <span class="k">then</span>
<span class="k">          do </span><span class="n">ii</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">ngam1</span>
             <span class="n">tmpgam1</span><span class="p">(</span><span class="n">ii</span><span class="p">)</span><span class="o">=</span><span class="n">log10</span><span class="p">(</span><span class="n">gam_min</span><span class="p">)</span><span class="o">+</span> <span class="p">&amp;</span>
                  <span class="p">(</span><span class="n">log10</span><span class="p">(</span><span class="n">gammax</span><span class="p">)</span><span class="o">-</span><span class="n">log10</span><span class="p">(</span><span class="n">gam_min</span><span class="p">))</span><span class="o">*</span> <span class="p">&amp;</span>
                  <span class="kt">REAL</span><span class="p">(</span><span class="n">ii</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="kt">REAL</span><span class="p">(</span><span class="n">ngam1</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
          <span class="k">end do</span>
<span class="k">          </span><span class="n">gam1</span><span class="o">=</span><span class="mi">10</span><span class="o">**</span><span class="p">(</span><span class="n">tmpgam1</span><span class="p">)</span>
       <span class="n">elseif</span> <span class="p">(</span><span class="nb">TRIM</span><span class="p">(</span><span class="n">cparams_ss</span><span class="p">%</span><span class="n">LAC_gam_resolution</span><span class="p">).</span><span class="n">eq</span><span class="p">.</span><span class="s1">&#39;2EXP&#39;</span><span class="p">)</span> <span class="k">then</span>
<span class="k">          do </span><span class="n">ii</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">ngam1</span>
             <span class="n">tmpgam1</span><span class="p">(</span><span class="n">ii</span><span class="p">)</span><span class="o">=</span><span class="n">log10</span><span class="p">(</span><span class="n">log10</span><span class="p">(</span><span class="n">gam_min</span><span class="p">))</span><span class="o">+</span> <span class="p">&amp;</span>
                  <span class="p">(</span><span class="n">log10</span><span class="p">(</span><span class="n">log10</span><span class="p">(</span><span class="n">gammax</span><span class="p">))</span><span class="o">-</span><span class="n">log10</span><span class="p">(</span><span class="n">log10</span><span class="p">(</span><span class="n">gam_min</span><span class="p">)))</span><span class="o">*</span> <span class="p">&amp;</span>
                  <span class="kt">REAL</span><span class="p">(</span><span class="n">ii</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="kt">REAL</span><span class="p">(</span><span class="n">ngam1</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
          <span class="k">end do</span>
<span class="k">          </span><span class="n">gam1</span><span class="o">=</span><span class="mi">10</span><span class="o">**</span><span class="p">(</span><span class="mi">10</span><span class="o">**</span><span class="p">(</span><span class="n">tmpgam1</span><span class="p">))</span>
       <span class="k">end if</span>

       <span class="c">!write(6,*) &#39;tmpgam1&#39;,tmpgam1</span>
       <span class="c">!write(6,*) &#39;gam1&#39;,gam1</span>


       <span class="n">pm1</span><span class="o">=</span><span class="nb">sqrt</span><span class="p">(</span><span class="n">gam1</span><span class="o">**</span><span class="mi">2</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>

       <span class="k">do </span><span class="n">ii</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">ngam1</span><span class="o">-</span><span class="mi">1</span>
          <span class="n">dpm1</span><span class="p">(</span><span class="n">ii</span><span class="p">)</span><span class="o">=</span><span class="n">pm1</span><span class="p">(</span><span class="n">ii</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">-</span><span class="n">pm1</span><span class="p">(</span><span class="n">ii</span><span class="p">)</span>
       <span class="k">end do</span>

<span class="k">       do </span><span class="n">ii</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">neta1</span>
          <span class="n">eta1</span><span class="p">(</span><span class="n">ii</span><span class="p">)</span><span class="o">=</span><span class="n">C_PI</span><span class="o">*</span><span class="p">(</span><span class="n">ii</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">neta1</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
       <span class="k">end do</span>

       <span class="c">!write(6,*) &#39;eta1&#39;,eta1</span>

       <span class="k">do </span><span class="n">ii</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">neta1</span><span class="o">-</span><span class="mi">1</span>
          <span class="n">deta1</span><span class="p">(</span><span class="n">ii</span><span class="p">)</span><span class="o">=</span><span class="n">eta1</span><span class="p">(</span><span class="n">ii</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">-</span><span class="n">eta1</span><span class="p">(</span><span class="n">ii</span><span class="p">)</span>
       <span class="k">end do</span>

<span class="k">       do </span><span class="n">ii</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">neta1</span>
          <span class="n">pm11</span><span class="p">(:,</span><span class="n">ii</span><span class="p">)</span><span class="o">=</span><span class="n">pm1</span>
          <span class="n">gam11</span><span class="p">(:,</span><span class="n">ii</span><span class="p">)</span><span class="o">=</span><span class="n">gam1</span>
       <span class="k">end do</span>

<span class="k">       do </span><span class="n">ii</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">ngam1</span>
          <span class="n">eta11</span><span class="p">(</span><span class="n">ii</span><span class="p">,:)</span><span class="o">=</span><span class="n">eta1</span>
       <span class="k">end do</span>

<span class="k">       </span>
<span class="k">       </span><span class="n">tmpcosgam</span><span class="o">=</span><span class="nb">sqrt</span><span class="p">(((</span><span class="n">gam</span><span class="p">(</span><span class="n">cc</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">gam1</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span><span class="o">/</span><span class="p">((</span><span class="n">gam</span><span class="p">(</span><span class="n">cc</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">gam1</span><span class="o">+</span><span class="mi">1</span><span class="p">)))</span>
       <span class="n">tmpdsigdgam</span><span class="o">=</span><span class="mi">2</span><span class="o">*</span><span class="n">C_PI</span><span class="o">*</span><span class="n">C_RE</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="p">(</span><span class="n">gam</span><span class="p">(</span><span class="n">cc</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span> <span class="p">&amp;</span>
            <span class="p">(((</span><span class="n">gam</span><span class="p">(</span><span class="n">cc</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="n">gam</span><span class="p">(</span><span class="n">cc</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="p">((</span><span class="n">gam1</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="n">gam</span><span class="p">(</span><span class="n">cc</span><span class="p">)</span><span class="o">-</span><span class="n">gam1</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">-</span> <span class="p">&amp;</span>
            <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">gam</span><span class="p">(</span><span class="n">cc</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="mi">2</span><span class="o">*</span><span class="n">gam</span><span class="p">(</span><span class="n">cc</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="p">((</span><span class="n">gam1</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">gam</span><span class="p">(</span><span class="n">cc</span><span class="p">)</span><span class="o">-</span><span class="n">gam1</span><span class="p">))</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
       <span class="n">tmpsecthreshgam</span><span class="o">=</span><span class="mf">1._rp</span>
       <span class="k">where</span><span class="p">(</span><span class="n">gam1</span><span class="p">.</span><span class="n">gt</span><span class="p">.(</span><span class="n">gam</span><span class="p">(</span><span class="n">cc</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mf">2._rp</span><span class="p">)</span> <span class="n">tmpsecthreshgam</span><span class="o">=</span><span class="mf">0._rp</span>

       <span class="c">!write(6,*) &#39;tmpcosgam&#39;,tmpcosgam</span>
       <span class="c">!write(6,*) &#39;tmpdsigdgam&#39;,tmpdsigdgam</span>
       <span class="c">!write(6,*) &#39;tmpsecthreshgam&#39;,tmpsecthreshgam</span>
       
       
       <span class="k">do </span><span class="n">ii</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">neta1</span>
          <span class="n">cosgam</span><span class="p">(:,</span><span class="n">ii</span><span class="p">)</span><span class="o">=</span><span class="n">tmpcosgam</span>
          <span class="n">dsigdgam</span><span class="p">(:,</span><span class="n">ii</span><span class="p">)</span><span class="o">=</span><span class="n">tmpdsigdgam</span>
          <span class="n">secthreshgam</span><span class="p">(:,</span><span class="n">ii</span><span class="p">)</span><span class="o">=</span><span class="n">tmpsecthreshgam</span>
       <span class="k">end do</span>

       <span class="c">!if (cc.eq.1) then</span>
          <span class="c">!write(6,*) cosgam</span>
       <span class="c">!end if</span>
       
       <span class="n">tmpsinsq</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">xi</span><span class="p">(</span><span class="n">cc</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="nb">sin</span><span class="p">(</span><span class="n">eta1</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>
       <span class="n">tmpcossq</span><span class="o">=</span><span class="n">xi</span><span class="p">(</span><span class="n">cc</span><span class="p">)</span><span class="o">*</span><span class="nb">cos</span><span class="p">(</span><span class="n">eta1</span><span class="p">)</span>

       <span class="k">do </span><span class="n">ii</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">ngam1</span>
          <span class="n">sinsq</span><span class="p">(</span><span class="n">ii</span><span class="p">,:)</span><span class="o">=</span><span class="n">tmpsinsq</span>
          <span class="n">tmpcossq1</span><span class="p">(</span><span class="n">ii</span><span class="p">,:)</span><span class="o">=</span><span class="n">tmpcossq</span>
       <span class="k">end do</span>

       <span class="c">!if (cc.eq.1) then</span>
          <span class="c">!write(6,*) sinsq</span>
       <span class="c">!end if</span>
       
       <span class="n">cossq</span><span class="o">=</span><span class="p">(</span><span class="n">cosgam</span><span class="o">-</span><span class="n">tmpcossq1</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>

       <span class="n">pitchrad</span><span class="o">=</span><span class="n">sinsq</span><span class="o">-</span><span class="n">cossq</span>
       <span class="k">where</span><span class="p">(</span><span class="n">pitchrad</span><span class="p">.</span><span class="n">lt</span><span class="p">.</span><span class="mi">0</span><span class="p">)</span> <span class="n">pitchrad</span><span class="o">=</span><span class="nb">tiny</span><span class="p">(</span><span class="mf">0._rp</span><span class="p">)</span>

       <span class="c">!if (cc.eq.1) then</span>
          <span class="c">!write(6,*) cossq</span>
          <span class="c">!write(6,*) &#39;sinsq-cossq&#39;,sqrt(sinsq-cossq)</span>
          <span class="c">!write(6,*) &#39;pitchrad&#39;,pitchrad</span>
       <span class="c">!end if</span>
       
       <span class="n">pitchprob</span><span class="o">=</span><span class="mi">1</span><span class="o">/</span><span class="p">(</span><span class="n">C_PI</span><span class="o">*</span><span class="nb">sqrt</span><span class="p">(</span><span class="n">pitchrad</span><span class="p">))</span>

       <span class="k">where</span><span class="p">(</span><span class="n">pitchprob</span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="mi">1</span><span class="o">/</span><span class="p">(</span><span class="n">C_PI</span><span class="o">*</span><span class="nb">sqrt</span><span class="p">(</span><span class="nb">tiny</span><span class="p">(</span><span class="mf">0._rp</span><span class="p">))))</span> <span class="n">pitchprob</span><span class="o">=</span><span class="mf">0._rp</span>

       <span class="c">!if (cc.eq.1) then</span>
          <span class="c">!write(6,*) &#39;pitchprob&#39;,pitchprob</span>
       <span class="c">!end if</span>
       
       <span class="n">S_LA</span><span class="o">=</span><span class="n">netot</span><span class="p">(</span><span class="n">cc</span><span class="p">)</span><span class="o">*</span><span class="n">params</span><span class="p">%</span><span class="n">cpp</span><span class="p">%</span><span class="n">density</span><span class="o">*</span><span class="n">C_C</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">C_PI</span><span class="p">)</span><span class="o">*</span> <span class="p">&amp;</span>
            <span class="p">(</span><span class="n">pm11</span><span class="o">/</span><span class="n">gam11</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">pm</span><span class="p">(</span><span class="n">cc</span><span class="p">)</span><span class="o">/</span><span class="n">gam</span><span class="p">(</span><span class="n">cc</span><span class="p">))</span><span class="o">*</span> <span class="p">&amp;</span>
            <span class="n">pitchprob</span><span class="o">*</span><span class="n">dsigdgam</span><span class="o">*</span><span class="n">secthreshgam</span>

       <span class="c">!! Saving maximum secondary RE source for use in rejection-acceptance</span>
       <span class="c">!! sampling algorithm </span>
       <span class="n">S_LAmax</span><span class="o">=</span><span class="nb">maxval</span><span class="p">(</span><span class="n">S_LA</span><span class="p">)</span>
       
       <span class="n">S_LA</span><span class="o">=</span><span class="n">S_LA</span><span class="o">*</span><span class="nb">sin</span><span class="p">(</span><span class="n">eta11</span><span class="p">)</span>

       <span class="c">!! Trapezoidal integration of secondary RE source to find probabilty</span>
       
       <span class="k">do </span><span class="n">ii</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">ngam1</span>
          <span class="n">probtmp</span><span class="p">(</span><span class="n">ii</span><span class="p">)</span><span class="o">=</span><span class="n">S_LA</span><span class="p">(</span><span class="n">ii</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">deta1</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="o">+</span><span class="n">S_LA</span><span class="p">(</span><span class="n">ii</span><span class="p">,</span><span class="n">neta1</span><span class="p">)</span><span class="o">*</span><span class="n">deta1</span><span class="p">(</span><span class="n">neta1</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span>
          <span class="c">!intpitchprob(ii)=pitchprob(ii,1)*sin(eta1(1))*deta1(1)/2+ &amp;</span>
          <span class="c">!     pitchprob(ii,neta1)*sin(eta1(neta1))*deta1(neta1-1)/2</span>
          <span class="k">do </span><span class="n">jj</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="n">neta1</span><span class="o">-</span><span class="mi">1</span>
             <span class="n">probtmp</span><span class="p">(</span><span class="n">ii</span><span class="p">)</span><span class="o">=</span><span class="n">probtmp</span><span class="p">(</span><span class="n">ii</span><span class="p">)</span><span class="o">+</span><span class="n">S_LA</span><span class="p">(</span><span class="n">ii</span><span class="p">,</span><span class="n">jj</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">deta1</span><span class="p">(</span><span class="n">jj</span><span class="p">)</span><span class="o">+</span><span class="n">deta1</span><span class="p">(</span><span class="n">jj</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span><span class="o">/</span><span class="mi">2</span>
          <span class="c">!   intpitchprob(ii)=intpitchprob(ii)+ &amp;</span>
          <span class="c">!        pitchprob(ii,jj)*sin(eta1(jj))*(deta1(jj)+deta1(jj-1))/2</span>
          <span class="k">end do</span>
<span class="k">       end do</span>

<span class="k">       </span><span class="n">prob1</span><span class="p">(</span><span class="n">cc</span><span class="p">)</span><span class="o">=</span><span class="n">probtmp</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">dpm1</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="o">+</span><span class="n">probtmp</span><span class="p">(</span><span class="n">ngam1</span><span class="p">)</span><span class="o">*</span><span class="n">dpm1</span><span class="p">(</span><span class="n">ngam1</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span>
       <span class="k">do </span><span class="n">jj</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="n">ngam1</span><span class="o">-</span><span class="mi">1</span>
          <span class="n">prob1</span><span class="p">(</span><span class="n">cc</span><span class="p">)</span><span class="o">=</span><span class="n">prob1</span><span class="p">(</span><span class="n">cc</span><span class="p">)</span><span class="o">+</span><span class="n">probtmp</span><span class="p">(</span><span class="n">jj</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">dpm1</span><span class="p">(</span><span class="n">jj</span><span class="p">)</span><span class="o">+</span><span class="n">dpm1</span><span class="p">(</span><span class="n">jj</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span><span class="o">/</span><span class="mi">2</span>
       <span class="k">end do</span>

       <span class="c">!write(6,*) &#39;prob1pre&#39;,prob1(cc),&#39;flagCol&#39;,flagCol(cc),&#39;flagCon&#39;,flagCon(cc),&#39;dt&#39;,dt</span>
       
       <span class="c">!write(6,*) &#39;intpitchprob&#39;,intpitchprob</span>
       
       <span class="n">prob1</span><span class="p">(</span><span class="n">cc</span><span class="p">)</span><span class="o">=</span><span class="n">prob1</span><span class="p">(</span><span class="n">cc</span><span class="p">)</span><span class="o">*</span><span class="n">dt</span><span class="o">*</span><span class="mi">2</span><span class="o">*</span><span class="n">C_PI</span><span class="o">*</span><span class="kt">REAL</span><span class="p">(</span><span class="n">flagCol</span><span class="p">(</span><span class="n">cc</span><span class="p">))</span><span class="o">*</span><span class="kt">REAL</span><span class="p">(</span><span class="n">flagCon</span><span class="p">(</span><span class="n">cc</span><span class="p">))</span>

       <span class="k">if</span> <span class="p">(</span><span class="n">ISNAN</span><span class="p">(</span><span class="n">prob1</span><span class="p">(</span><span class="n">cc</span><span class="p">)))</span> <span class="k">then</span>
<span class="k">          write</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="s1">&#39;NaN probability from secondary RE source&#39;</span>
          <span class="k">write</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="s1">&#39;p,xi&#39;</span><span class="p">,</span><span class="n">pm</span><span class="p">(</span><span class="n">cc</span><span class="p">),</span><span class="n">xi</span><span class="p">(</span><span class="n">cc</span><span class="p">)</span>
          <span class="k">write</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="s1">&#39;gam_min,gammax&#39;</span><span class="p">,</span><span class="n">gam_min</span><span class="p">,</span><span class="n">gammax</span>
          <span class="k">write</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="s1">&#39;E&#39;</span><span class="p">,</span><span class="n">E_PHI</span><span class="p">(</span><span class="n">cc</span><span class="p">)</span><span class="o">*</span><span class="n">params</span><span class="p">%</span><span class="n">cpp</span><span class="p">%</span><span class="n">Eo</span>
          <span class="k">write</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="s1">&#39;E_C&#39;</span><span class="p">,</span><span class="n">E_C</span><span class="o">*</span><span class="n">params</span><span class="p">%</span><span class="n">cpp</span><span class="p">%</span><span class="n">Eo</span>
          <span class="c">!write(6,*) &#39;pitchprob&#39;,pitchprob</span>
          <span class="c">!write(6,*) &#39;S_LA&#39;,S_LA</span>
          <span class="k">call </span><span class="n">korc_abort</span><span class="p">(</span><span class="mi">24</span><span class="p">)</span>
       <span class="k">end if</span>

<span class="k">       if</span> <span class="p">(</span><span class="n">prob1</span><span class="p">(</span><span class="n">cc</span><span class="p">).</span><span class="n">gt</span><span class="p">.</span><span class="mf">1._rp</span><span class="p">)</span> <span class="k">then</span>
<span class="k">          write</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="s1">&#39;Multiple secondary REs generated in a collisional time step&#39;</span>
          <span class="k">write</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="s1">&#39;p,xi&#39;</span><span class="p">,</span><span class="n">pm</span><span class="p">(</span><span class="n">cc</span><span class="p">),</span><span class="n">xi</span><span class="p">(</span><span class="n">cc</span><span class="p">)</span>
          <span class="k">write</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="s1">&#39;gam_min,gammax&#39;</span><span class="p">,</span><span class="n">gam_min</span><span class="p">,</span><span class="n">gammax</span>
          <span class="k">write</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="s1">&#39;E&#39;</span><span class="p">,</span><span class="n">E_PHI</span><span class="p">(</span><span class="n">cc</span><span class="p">)</span><span class="o">*</span><span class="n">params</span><span class="p">%</span><span class="n">cpp</span><span class="p">%</span><span class="n">Eo</span>
          <span class="k">write</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="s1">&#39;E_C&#39;</span><span class="p">,</span><span class="n">E_C</span><span class="o">*</span><span class="n">params</span><span class="p">%</span><span class="n">cpp</span><span class="p">%</span><span class="n">Eo</span>
          <span class="k">call </span><span class="n">korc_abort</span><span class="p">(</span><span class="mi">24</span><span class="p">)</span>
       <span class="k">end if</span>

       <span class="c">!write(6,*) &#39;gam&#39;,gam(cc),&#39;xi&#39;,xi(cc)</span>
       <span class="c">!write(6,*) &#39;prob1&#39;,prob1(cc),&#39;prob0&#39;,prob0(cc)</span>
       
       <span class="k">if</span> <span class="p">(</span><span class="n">prob1</span><span class="p">(</span><span class="n">cc</span><span class="p">).</span><span class="n">gt</span><span class="p">.</span><span class="n">prob0</span><span class="p">(</span><span class="n">cc</span><span class="p">))</span> <span class="k">then</span>

          <span class="c">!! If secondary RE generated, begin acceptance-rejection sampling</span>
          <span class="c">!! algorithm</span>
          
          <span class="c">!write(6,*) &#39;secondary RE from &#39;,prob1,prob0</span>
          
          <span class="n">accepted</span><span class="o">=</span><span class="p">.</span><span class="n">false</span><span class="p">.</span>

          <span class="n">gamsecmax</span><span class="o">=</span><span class="p">(</span><span class="n">gam</span><span class="p">(</span><span class="n">cc</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span>
          <span class="n">psecmax</span><span class="o">=</span><span class="nb">sqrt</span><span class="p">(</span><span class="n">gamsecmax</span><span class="o">**</span><span class="mi">2</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>

          <span class="n">seciter</span><span class="o">=</span><span class="mi">0</span>
          <span class="k">do while</span> <span class="p">(.</span><span class="nb">not</span><span class="p">.</span><span class="n">accepted</span><span class="p">)</span>

             <span class="n">ptrial</span><span class="o">=</span><span class="n">p_min</span><span class="o">+</span><span class="p">(</span><span class="n">psecmax</span><span class="o">-</span><span class="n">p_min</span><span class="p">)</span><span class="o">*</span><span class="n">get_random</span><span class="p">()</span>
             <span class="n">gamtrial</span><span class="o">=</span><span class="nb">sqrt</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">ptrial</span><span class="o">*</span><span class="n">ptrial</span><span class="p">)</span>

             <span class="n">cosgam1</span><span class="o">=</span><span class="nb">sqrt</span><span class="p">(((</span><span class="n">gam</span><span class="p">(</span><span class="n">cc</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">gamtrial</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span><span class="o">/</span><span class="p">((</span><span class="n">gam</span><span class="p">(</span><span class="n">cc</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">gamtrial</span><span class="o">+</span><span class="mi">1</span><span class="p">)))</span>
             
             <span class="c">!xirad=sqrt((cosgam1*xi(cc))**2-(xi(cc)**2+cosgam1**2-1))</span>

             <span class="c">!if (isnan(xirad)) then</span>
             <span class="c">!   write(6,*) &#39;Sample not in allowable region of phase space&#39;</span>
             <span class="c">!   call korc_abort(24)</span>
             <span class="c">!end if</span>

             <span class="c">!xip=cosgam1*xi(cc)+xirad</span>
             <span class="c">!xim=cosgam1*xi(cc)-xirad</span>

             <span class="c">!xitrial=xim+(xip-xim)*get_random()</span>
             <span class="n">xitrial</span><span class="o">=-</span><span class="mi">1</span><span class="o">+</span><span class="mi">2</span><span class="o">*</span><span class="n">get_random</span><span class="p">()</span>

             <span class="n">sinsq1</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">xi</span><span class="p">(</span><span class="n">cc</span><span class="p">)</span><span class="o">*</span><span class="n">xi</span><span class="p">(</span><span class="n">cc</span><span class="p">))</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">xitrial</span><span class="o">*</span><span class="n">xitrial</span><span class="p">)</span>
             <span class="n">cossq1</span><span class="o">=</span><span class="p">(</span><span class="n">cosgam1</span><span class="o">-</span><span class="n">xi</span><span class="p">(</span><span class="n">cc</span><span class="p">)</span><span class="o">*</span><span class="n">xitrial</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>
             <span class="n">pitchprob1</span><span class="o">=</span><span class="mi">1</span><span class="o">/</span><span class="p">(</span><span class="n">C_PI</span><span class="o">*</span><span class="nb">sqrt</span><span class="p">(</span><span class="n">sinsq1</span><span class="o">-</span><span class="n">cossq1</span><span class="p">))</span>

             <span class="c">!if (isnan(pitchprob1)) cycle</span>

             <span class="n">dsigdgam1</span><span class="o">=</span><span class="mi">2</span><span class="o">*</span><span class="n">C_PI</span><span class="o">*</span><span class="n">C_RE</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="p">(</span><span class="n">gam</span><span class="p">(</span><span class="n">cc</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span> <span class="p">&amp;</span>
                  <span class="p">(((</span><span class="n">gam</span><span class="p">(</span><span class="n">cc</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="n">gam</span><span class="p">(</span><span class="n">cc</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span> <span class="p">&amp;</span>
                  <span class="p">((</span><span class="n">gamtrial</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="n">gam</span><span class="p">(</span><span class="n">cc</span><span class="p">)</span><span class="o">-</span><span class="n">gamtrial</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">-</span> <span class="p">&amp;</span>
                  <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">gam</span><span class="p">(</span><span class="n">cc</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="mi">2</span><span class="o">*</span><span class="n">gam</span><span class="p">(</span><span class="n">cc</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span> <span class="p">&amp;</span>
                  <span class="p">((</span><span class="n">gamtrial</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">gam</span><span class="p">(</span><span class="n">cc</span><span class="p">)</span><span class="o">-</span><span class="n">gamtrial</span><span class="p">))</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>

             <span class="n">S_LA1</span><span class="o">=</span><span class="n">netot</span><span class="p">(</span><span class="n">cc</span><span class="p">)</span><span class="o">*</span><span class="n">params</span><span class="p">%</span><span class="n">cpp</span><span class="p">%</span><span class="n">density</span><span class="o">*</span><span class="n">C_C</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">C_PI</span><span class="p">)</span><span class="o">*</span> <span class="p">&amp;</span>
                  <span class="p">(</span><span class="n">ptrial</span><span class="o">/</span><span class="n">gamtrial</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">pm</span><span class="p">(</span><span class="n">cc</span><span class="p">)</span><span class="o">/</span><span class="n">gam</span><span class="p">(</span><span class="n">cc</span><span class="p">))</span><span class="o">*</span> <span class="p">&amp;</span>
                  <span class="n">pitchprob1</span><span class="o">*</span><span class="n">dsigdgam1</span>

             <span class="k">if</span> <span class="p">(</span><span class="n">S_LA1</span><span class="o">/</span><span class="n">S_LAmax</span><span class="p">.</span><span class="n">gt</span><span class="p">.</span><span class="n">get_random</span><span class="p">())</span> <span class="n">accepted</span><span class="o">=</span><span class="p">.</span><span class="n">true</span><span class="p">.</span>

             <span class="n">seciter</span><span class="o">=</span><span class="n">seciter</span><span class="o">+</span><span class="mi">1</span>

             <span class="c">!if (mod(seciter,100).eq.0) then</span>
             <span class="c">!   write(6,*) &#39;iteration&#39;,seciter</span>
             <span class="c">!end if</span>
             
          <span class="k">end do</span>

          <span class="c">!! Write secondary RE degrees of freedom to particle derived type</span>

          
          <span class="c">!$OMP ATOMIC UPDATE</span>
          <span class="n">spp</span><span class="p">%</span><span class="n">pRE</span><span class="o">=</span><span class="n">spp</span><span class="p">%</span><span class="n">pRE</span><span class="o">+</span><span class="mi">1</span>
          <span class="c">!$OMP ATOMIC WRITE</span>
          <span class="n">spp</span><span class="p">%</span><span class="n">vars</span><span class="p">%</span><span class="n">flagRE</span><span class="p">(</span><span class="n">spp</span><span class="p">%</span><span class="n">pRE</span><span class="p">)</span><span class="o">=</span><span class="mi">1</span>
          <span class="c">!$OMP ATOMIC WRITE</span>
          <span class="n">spp</span><span class="p">%</span><span class="n">vars</span><span class="p">%</span><span class="n">flagCon</span><span class="p">(</span><span class="n">spp</span><span class="p">%</span><span class="n">pRE</span><span class="p">)</span><span class="o">=</span><span class="mi">1</span>
          <span class="c">!$OMP ATOMIC WRITE</span>
          <span class="n">spp</span><span class="p">%</span><span class="n">vars</span><span class="p">%</span><span class="n">flagCol</span><span class="p">(</span><span class="n">spp</span><span class="p">%</span><span class="n">pRE</span><span class="p">)</span><span class="o">=</span><span class="mi">1</span>
          <span class="c">!$OMP ATOMIC WRITE</span>
          <span class="n">spp</span><span class="p">%</span><span class="n">vars</span><span class="p">%</span><span class="n">V</span><span class="p">(</span><span class="n">spp</span><span class="p">%</span><span class="n">pRE</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">=</span><span class="n">ptrial</span><span class="o">*</span><span class="n">xitrial</span>
          <span class="c">!$OMP ATOMIC WRITE</span>
          <span class="n">spp</span><span class="p">%</span><span class="n">vars</span><span class="p">%</span><span class="n">V</span><span class="p">(</span><span class="n">spp</span><span class="p">%</span><span class="n">pRE</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">=</span><span class="n">ptrial</span><span class="o">*</span><span class="n">ptrial</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">xitrial</span><span class="o">*</span><span class="n">xitrial</span><span class="p">)</span><span class="o">/</span> <span class="p">&amp;</span>
               <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">me</span><span class="o">*</span><span class="n">Bmag</span><span class="p">(</span><span class="n">cc</span><span class="p">))</span>
          <span class="c">!$OMP ATOMIC WRITE</span>
          <span class="n">spp</span><span class="p">%</span><span class="n">vars</span><span class="p">%</span><span class="n">Y</span><span class="p">(</span><span class="n">spp</span><span class="p">%</span><span class="n">pRE</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">=</span><span class="n">Y_R</span><span class="p">(</span><span class="n">cc</span><span class="p">)</span>
          <span class="c">!$OMP ATOMIC WRITE</span>
          <span class="n">spp</span><span class="p">%</span><span class="n">vars</span><span class="p">%</span><span class="n">Y</span><span class="p">(</span><span class="n">spp</span><span class="p">%</span><span class="n">pRE</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">=</span><span class="n">Y_PHI</span><span class="p">(</span><span class="n">cc</span><span class="p">)</span>
          <span class="c">!$OMP ATOMIC WRITE</span>
          <span class="n">spp</span><span class="p">%</span><span class="n">vars</span><span class="p">%</span><span class="n">Y</span><span class="p">(</span><span class="n">spp</span><span class="p">%</span><span class="n">pRE</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span><span class="o">=</span><span class="n">Y_Z</span><span class="p">(</span><span class="n">cc</span><span class="p">)</span>
          
          <span class="c">!! Write changes to primary RE degrees of freedom to temporary</span>
          <span class="c">!! arrays for passing back out to particle derived type</span>

<span class="cp">#if DBG_CHECK    </span>
          <span class="k">if</span> <span class="p">(</span><span class="n">spp</span><span class="p">%</span><span class="n">vars</span><span class="p">%</span><span class="n">V</span><span class="p">(</span><span class="n">spp</span><span class="p">%</span><span class="n">pRE</span><span class="p">,</span><span class="mi">2</span><span class="p">).</span><span class="n">lt</span><span class="p">.</span><span class="mf">0._rp</span><span class="p">)</span> <span class="k">then</span>
<span class="k">             write</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="s1">&#39;mu is negative for secondary&#39;</span>
             <span class="k">write</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="s1">&#39;ppll,mu&#39;</span><span class="p">,</span><span class="n">spp</span><span class="p">%</span><span class="n">vars</span><span class="p">%</span><span class="n">V</span><span class="p">(</span><span class="n">spp</span><span class="p">%</span><span class="n">pRE</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span><span class="n">spp</span><span class="p">%</span><span class="n">vars</span><span class="p">%</span><span class="n">V</span><span class="p">(</span><span class="n">spp</span><span class="p">%</span><span class="n">pRE</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
             <span class="k">write</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="s1">&#39;pm,xi&#39;</span><span class="p">,</span><span class="n">ptrial</span><span class="p">,</span><span class="n">xitrial</span>
             <span class="k">write</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="s1">&#39;xim,xip&#39;</span><span class="p">,</span><span class="n">xim</span><span class="p">,</span><span class="n">xip</span>
             <span class="k">write</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="s1">&#39;pmin,psecmax&#39;</span><span class="p">,</span><span class="n">p_min</span><span class="p">,</span><span class="n">psecmax</span>
             <span class="k">call </span><span class="n">korc_abort</span><span class="p">(</span><span class="mi">24</span><span class="p">)</span>
          <span class="k">end if</span>
<span class="cp"># endif</span>
          
          <span class="k">if</span> <span class="p">(</span><span class="n">cparams_ss</span><span class="p">%</span><span class="n">ConserveLA</span><span class="p">)</span> <span class="k">then</span>
<span class="k">             </span><span class="n">tmppm</span><span class="o">=</span><span class="n">pm</span><span class="p">(</span><span class="n">cc</span><span class="p">)</span>
             <span class="n">gamvth</span><span class="o">=</span><span class="mi">1</span><span class="o">/</span><span class="nb">sqrt</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">Te</span><span class="p">(</span><span class="n">cc</span><span class="p">))</span>
             <span class="n">gam</span><span class="p">(</span><span class="n">cc</span><span class="p">)</span><span class="o">=</span><span class="n">gam</span><span class="p">(</span><span class="n">cc</span><span class="p">)</span><span class="o">-</span><span class="n">gamtrial</span><span class="o">+</span><span class="n">gamvth</span>
             <span class="n">pm</span><span class="p">(</span><span class="n">cc</span><span class="p">)</span><span class="o">=</span><span class="nb">sqrt</span><span class="p">(</span><span class="n">gam</span><span class="p">(</span><span class="n">cc</span><span class="p">)</span><span class="o">*</span><span class="n">gam</span><span class="p">(</span><span class="n">cc</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
             <span class="n">xi</span><span class="p">(</span><span class="n">cc</span><span class="p">)</span><span class="o">=</span><span class="p">(</span><span class="n">tmppm</span><span class="o">*</span><span class="n">xi</span><span class="p">(</span><span class="n">cc</span><span class="p">)</span><span class="o">-</span><span class="n">ptrial</span><span class="o">*</span><span class="n">xitrial</span><span class="p">)</span><span class="o">/</span><span class="n">pm</span><span class="p">(</span><span class="n">cc</span><span class="p">)</span>
          <span class="k">end if</span>

          <span class="c">!$OMP ATOMIC READ</span>
          <span class="n">pRE</span><span class="o">=</span><span class="n">spp</span><span class="p">%</span><span class="n">pRE</span>
          
          <span class="k">if</span> <span class="p">(</span><span class="n">pRE</span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="n">spp</span><span class="p">%</span><span class="n">ppp</span><span class="p">)</span> <span class="k">then</span>
<span class="k">             write</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="s1">&#39;All REs allocated on proc&#39;</span><span class="p">,</span><span class="n">params</span><span class="p">%</span><span class="n">mpi_params</span><span class="p">%</span><span class="n">rank</span>
             <span class="k">call </span><span class="n">korc_abort</span><span class="p">(</span><span class="mi">24</span><span class="p">)</span>
          <span class="k">end if</span>
<span class="k">          </span>
<span class="k">       end if</span>
<span class="k">       </span>
<span class="k">    end do</span>


<span class="k">    </span>
<span class="k">  end subroutine </span><span class="n">large_angle_source</span>
</pre></div>

    </section>
    <br>
    
    
    </div>
  </div>


    <hr>    
    </div> <!-- /container -->
    <footer>
      <div class="container">
      <div class="row">
        <div class="col-xs-6 col-md-4"><p>&copy; 2022 
                                          </p></div>
        <div class="col-xs-6 col-md-4 col-md-push-4">
          <p class="text-right">
            Documentation generated by 
            <a href="https://github.com/cmacmackin/ford">FORD</a>
             on  
          </p>
        </div>
        <div class="col-xs-12 col-md-4 col-md-pull-4"><p class="text-center"> KORC was developed by Matt Beidler</p></div>
      </div>
      <br>
      </div> <!-- /container -->    
    </footer>

    <!-- Bootstrap core JavaScript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
<!--
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
-->
    <script src="../js/bootstrap.min.js"></script>
    <!-- IE10 viewport hack for Surface/desktop Windows 8 bug -->
    <script src="../js/ie10-viewport-bug-workaround.js"></script>

    <!-- MathJax JavaScript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({
        TeX: { extensions: ['AMSmath.js','AMSsymbols.js','noErrors.js','noUndefined.js'], equationNumbers: { autoNumber: 'AMS' } },
        jax: ['input/TeX','input/MathML','output/HTML-CSS'],
        extensions: ['tex2jax.js','mml2jax.js','MathMenu.js','MathZoom.js']
      });
    </script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    
    
    <script src="../tipuesearch/tipuesearch_content.js"></script>
    <script src="../tipuesearch/tipuesearch_set.js"></script>
    <script src="../tipuesearch/tipuesearch.js"></script>
    
    
  </body>
</html>